import functions_framework
import pandas as pd
import sqlalchemy
from weather_api import fetch_weather_data
from flights_api import fetch_flight_data

# Example inputs
COORDINATES = [
    ["Buenos Aires", -34.6037, -58.3816],
    ["Munich", 48.1351, 11.5820],
    ["Berlin", 52.5200, 13.4050],
    ["Hamburg", 53.5511, 9.9937]
]
IATAS = ["BER", "MUC", "HAM", "EZE"]
WEATHER_API_KEY = "YOUR_WEATHER_API_KEY"
FLIGHTS_API_KEY = "YOUR_RAPIDAPI_KEY"

@functions_framework.http
def retrieve_send_data(request):
    conn_str = f"mysql+pymysql://root:Your_password@Your_Host:3306/cities_cloud"

    # Fetch weather and flights data
    weather_df = fetch_weather_data(COORDINATES, WEATHER_API_KEY)
    departures_df, arrivals_df = fetch_flight_data(IATAS, FLIGHTS_API_KEY)

    # Send to Cloud SQL
    weather_df.to_sql("weather_df", if_exists="append", con=conn_str, index=False)
    departures_df.to_sql("flight_departures", if_exists="append", con=conn_str, index=False)
    arrivals_df.to_sql("flight_arrivals", if_exists="append", con=conn_str, index=False)

    return "Data updated successfully"
